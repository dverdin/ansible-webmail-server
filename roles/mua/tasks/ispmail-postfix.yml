---
- name: setup Postfix custom configuration
  template: src=postfix-main.cf.j2 dest=/etc/postfix/main.cf
  notify: restart postfix
  
- name: Creating directory for MySQL mappings.
  file: path=/etc/postfix/mysql mode=0644 state=directory

- name: define Postfix virtual mailbox domain mapping
  template: src=postfix-mysql-relay_domains.cf.j2 dest=/etc/postfix/mysql/relay_domains.cf
  notify: restart postfix

- name: define Postfix virtual mailbox mapping
  template: src=postfix-mysql-virtual_alias_maps.cf.j2 dest=/etc/postfix/mysql/virtual_alias_maps.cf
  notify: restart postfix

- name: define Postfix virtual alias mapping
  template: src=postfix-mysql-virtual_domains_maps.cf.j2 dest=/etc/postfix/mysql/virtual_domains_maps.cf
  notify: restart postfix

- name: define Postfix virtual alias mapping
  template: src=postfix-mysql-virtual_mailbox_maps.cf.j2 dest=/etc/postfix/mysql/virtual_mailbox_maps.cf
  notify: restart postfix

- name: Restricting access to database mapping files that contain a password
  file: path=/etc/postfix/mysql/{{item}}.cf mode=0644 owner=root group=root
  with_items:
  - relay_domains
  - virtual_alias_maps
  - virtual_domains_maps
  - virtual_mailbox_maps

- name: Make Postfix use LMTP to send emails to Dovecot
  command: postconf virtual_transport=lmtp:unix:private/dovecot-lmtp

- name: Setting SMTP authentication type to dovecot
  command: postconf smtpd_sasl_type=dovecot

- name: Setting SMTP authentication path/socket
  command: postconf smtpd_sasl_path=private/auth

- name: Enabling SMTP authentication
  command: postconf smtpd_sasl_auth_enable=yes

- name: Setting SMTP encryption security level
  command: postconf smtpd_tls_security_level=may

- name: Setting SMTP encryption security level
  command: postconf smtpd_tls_security_level=may

- name: Enforce SMTP encryption
  command: postconf smtpd_tls_auth_only=yes

- name: Set TLS encryption certificate
  command: postconf smtpd_tls_cert_file=/etc/ssl/certs/mailserver.pem

- name: Set TLS encryption key
  command: postconf smtpd_tls_key_file=/etc/ssl/private/mailserver.pem

- name: Enabling Spamassassin milter
  command: postconf smtpd_milters=unix:/spamass/spamass.sock

- name: Configuring Spamassassin milter
  command: postconf milter_connect_macros="i j {daemon_name} v {if_name} _"

- name: Setting spamd options
  copy: src=etc-default-spamassassin dest=/etc/default/spamassassin
  notify: restart spamassassin

- name: Adding user spamass-milter to debian-spamd group
  user: name=spamass-milter groups=debian-spamd
  notify: restart spamassassin

- name: Allow emails up to 40 MB large
  command: postconf message_size_limit=41943040

- name: Make Postfix listen on all interfaces
  command: postconf inet_interfaces=all
